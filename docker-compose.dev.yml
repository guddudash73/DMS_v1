services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    command: ['-jar', 'DynamoDBLocal.jar', '-sharedDb', '-inMemory', '-port', '8000']
    ports:
      - '8000:8000'
    volumes:
      - ddbdata:/home/dynamodblocal/data

  localstack:
    image: localstack/localstack:latest
    environment:
      - SERVICES=s3
      - DEBUG=0
      - AWS_DEFAULT_REGION=us-east-1
    ports:
      - '4566:4566'
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - localstackdata:/var/lib/localstack

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      # Runtime mode
      NODE_ENV: development
      PORT: 4000

      # AWS + local emulators
      AWS_REGION: us-east-1
      DYNAMO_ENDPOINT: http://dynamodb-local:8000
      S3_ENDPOINT: http://localstack:4566

      # Table / bucket naming for local dev
      DDB_TABLE_NAME: dms-test-table
      XRAY_BUCKET_NAME: dms-xray-test

      # Local dev credentials for LocalStack / DDB Local
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test

      # Token lifetimes
      ACCESS_TOKEN_TTL_SEC: 900
      REFRESH_TOKEN_TTL_SEC: 1209600

      # CORS for web app on localhost:3000
      CORS_ORIGIN: http://localhost:3000

      # Dev-only secrets (override via real env in stage/prod)
      JWT_ACCESS_SECRET: dev-only-access-secret-change-me
      JWT_REFRESH_SECRET: dev-only-refresh-secret-change-me
    ports:
      - '4000:4000'
    depends_on:
      - dynamodb-local
      - localstack

volumes:
  ddbdata:
  localstackdata:
