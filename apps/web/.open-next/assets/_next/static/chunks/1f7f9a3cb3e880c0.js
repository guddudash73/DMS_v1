(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,96459,e=>{"use strict";var t=e.i(43476),s=e.i(71645),i=e.i(18566),a=e.i(70319),r=e.i(66691),n=e.i(70317),l=e.i(24911),d=e.i(25466),o=e.i(70931),c=e.i(50106);let u=e=>{let t="number"==typeof e?e:Number(e);return Number.isFinite(t)?t:0},x=e=>"object"==typeof e&&null!==e,m=(e,t)=>{if(!x(e))return;let s=e[t];return"string"==typeof s?s:void 0},h=(e,t)=>{if(!x(e))return;let s=e[t];return"boolean"==typeof s?s:void 0},p=(e,t)=>{if(!x(e))return;let s=e[t];return"number"==typeof s&&Number.isFinite(s)?s:void 0},g=e=>{if(e instanceof Error||x(e)&&"string"==typeof e.message)return e.message};function f(e){return(0,t.jsx)("svg",{viewBox:"0 0 24 24",fill:"none","aria-hidden":"true",...e,children:(0,t.jsx)("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}function b(e){return(0,t.jsxs)("svg",{viewBox:"0 0 24 24",fill:"none","aria-hidden":"true",...e,children:[(0,t.jsx)("path",{d:"M12 20h9",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),(0,t.jsx)("path",{d:"M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5Z",stroke:"currentColor",strokeWidth:"2",strokeLinejoin:"round"})]})}function v(e){return(0,t.jsx)("svg",{viewBox:"0 0 24 24",fill:"none","aria-hidden":"true",...e,children:(0,t.jsx)("path",{d:"M18 6 6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}function j(){let e=(0,i.useParams)(),j=(0,i.useRouter)(),N=(0,c.useAuth)(),y="ADMIN"===("authenticated"===N.status?N.role:void 0),k=String(e?.visitId??""),w=(0,o.useGetVisitByIdQuery)(k,{skip:!k}),A=w.data,C=!0===h(A,"checkedOut")||void 0!==p(A,"billingAmount")||0===p(A,"billingAmount"),E=!0===h(A,"isOffline"),S=!!k&&!!A&&C&&y,B=m(A,"patientId"),D=(0,o.useGetPatientByIdQuery)(B??"",{skip:!B}),L=(0,o.useGetVisitBillQuery)({visitId:k},{skip:!S}),M=L.data??null,I=!C;s.useEffect(()=>{!k||A&&!y&&C&&j.replace(`/visits/${k}/checkout/printing`)},[k,A,y,C,j]);let O=!0===h(A,"zeroBilled"),[F,T]=s.useState(!1),[R,q]=(0,o.useUpdateVisitBillMutation)();s.useEffect(()=>{T(!1)},[k]);let K=m(A,"status"),V=!!k&&!!A&&("DONE"===K||E),[Z,P]=(0,o.useCheckoutVisitMutation)(),[U,$]=(0,o.useUpdateVisitStatusMutation)(),[W,G]=s.useState([]),[Q,_]=s.useState(0),[z,Y]=s.useState(0),[H,J]=s.useState(""),[X,ee]=s.useState(""),[et,es]=s.useState(null),[ei,ea]=s.useState(""),[er,en]=s.useState(""),[el,ed]=s.useState(!1),[eo,ec]=s.useState(!1),eu=s.useRef(!1);s.useEffect(()=>{if(!M||eu.current)return;eu.current=!0,G((!x(M)||!Array.isArray(M.items)?[]:M.items).map(e=>({description:"string"==typeof e.description?e.description:"",unitAmount:u(e.unitAmount)}))),_(u(x(M)?M.discountAmount:0)),Y(u(x(M)?M.taxAmount:0));let e=x(M)?M.receivedOnline:void 0,t=x(M)?M.receivedOffline:void 0;ed(!0===e),ec(!0===t)},[M]);let ex=O&&!F,em=s.useMemo(()=>{if(ex)return{subtotal:0,discount:0,tax:0,total:0,safeLines:[]};let e=W.map(e=>({description:(e.description??"").trim(),unitAmount:Math.max(0,u(e.unitAmount))})).filter(e=>e.description.length>0),t=e.reduce((e,t)=>e+t.unitAmount,0),s=Math.max(0,u(Q)),i=Math.max(0,u(z)),a=Math.max(0,t-Math.min(s,t)+i);return{subtotal:t,discount:s,tax:i,total:a,safeLines:e}},[W,Q,z,ex]),eh=D.data?.name,ep=D.data?.phone,eg=m(A,"doctorId")??m(A,"providerId")??m(A,"assignedDoctorId"),ef=eg?`Doctor (${eg})`:"Doctor",eb=m(A,"visitDate")??"—",ev=s.useRef(null),ej=s.useRef(null),eN=s.useRef(null),ey=s.useRef(null),ek=s.useRef(null);s.useEffect(()=>{requestAnimationFrame(()=>ev.current?.focus())},[]);let ew=()=>{if(null===et)return;let e=ei.trim(),t=Math.max(0,u(er));if(!e){a.toast.info("Service name cannot be empty."),ey.current?.focus();return}G(s=>s.map((s,i)=>i===et?{description:e,unitAmount:t}:s)),es(null),ea(""),en(""),requestAnimationFrame(()=>ev.current?.focus())},eA=()=>{es(null),ea(""),en(""),requestAnimationFrame(()=>ev.current?.focus())},eC=async()=>{if(!A)return;let e=m(A,"status");if(E&&"DONE"!==e)try{await U({visitId:k,status:"DONE"}).unwrap(),await w.refetch()}catch(t){let e=m(t.data,"message")||g(t)||"Failed to mark visit DONE.";a.toast.error(e);return}if(!E&&"DONE"!==e)return void a.toast.error("Checkout is only allowed when visit is DONE.");let t=ex?{items:[{description:"Zero billed",quantity:1,unitAmount:0}],discountAmount:0,taxAmount:0,allowZeroBilled:!0,receivedOnline:el,receivedOffline:eo}:{items:em.safeLines.length?em.safeLines.map(e=>({description:e.description,quantity:1,unitAmount:e.unitAmount})):[{description:E?"Offline Rx":"Consultation",quantity:1,unitAmount:0}],discountAmount:em.discount,taxAmount:em.tax,...O?{allowZeroBilled:!0}:{},receivedOnline:el,receivedOffline:eo};try{C?(await R({visitId:k,input:t}).unwrap(),a.toast.success("Bill updated.")):(await Z({visitId:k,input:t}).unwrap(),a.toast.success("Checkout saved.")),j.replace(`/visits/${k}/checkout/printing`)}catch(s){let e=m(s.data,"error"),t=m(s.data,"message")||g(s)||"Checkout failed.";"VISIT_NOT_DONE"===e?a.toast.error("Visit must be DONE before checkout."):"DUPLICATE_CHECKOUT"===e?a.toast.error("This visit is already checked out."):a.toast.error(t)}};if(M&&!y)return(0,t.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"Redirecting…"});let eE=!V||P.isLoading||q.isLoading||$.isLoading;return(0,t.jsxs)("section",{className:"p-4 2xl:p-8",children:[(0,t.jsxs)("div",{className:"mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:M?"Edit Bill":"Billing"}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["Tag: ",m(A,"tag")??"—"," · Zero billed: ",O?"Yes":"No"," · Status: ",m(A,"status")??"—",E?" · Offline: Yes":""]})]}),(0,t.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,t.jsx)(r.Button,{type:"button",variant:"outline",className:"rounded-xl cursor-pointer",onClick:()=>j.back(),children:"Back"}),(0,t.jsx)(r.Button,{type:"button",variant:"default",className:"rounded-xl bg-black text-white hover:bg-black/90 cursor-pointer",onClick:()=>void eC(),disabled:eE,children:P.isLoading||q.isLoading||$.isLoading?"Saving…":M?"Save changes":"Save"})]})]}),O?(0,t.jsx)(n.Card,{className:"mb-4 rounded-2xl border bg-white p-4",children:(0,t.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[(0,t.jsxs)("div",{className:"text-sm text-gray-700",children:[(0,t.jsx)("div",{className:"font-semibold text-gray-900",children:"Zero-billed (Z) visit"}),(0,t.jsxs)("div",{className:"mt-1 text-xs text-gray-600",children:["Billing is ",(0,t.jsx)("span",{className:"font-semibold",children:"disabled by default"}),". Click “Save” to continue with a ₹0 bill. If you want to add charges, click “Enable billing”."]})]}),(0,t.jsx)("div",{className:"flex items-center gap-2",children:(0,t.jsx)(r.Button,{type:"button",variant:"outline",className:"rounded-xl",onClick:()=>{T(!0),a.toast.info("Billing enabled for this zero-billed visit."),requestAnimationFrame(()=>ev.current?.focus())},disabled:F,children:F?"Billing enabled":"Enable billing"})})]})}):null,(0,t.jsxs)("div",{className:"mb-3 grid grid-cols-1 gap-3 md:grid-cols-3",children:[(0,t.jsxs)(n.Card,{className:"rounded-2xl border bg-white p-4",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Patient"}),(0,t.jsx)("div",{className:"mt-1 text-base font-semibold text-gray-900",children:eh??"—"}),(0,t.jsx)("div",{className:"mt-1 text-sm text-gray-600",children:ep??"—"})]}),(0,t.jsxs)(n.Card,{className:"rounded-2xl border bg-white p-4",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Doctor"}),(0,t.jsx)("div",{className:"mt-1 text-base font-semibold text-gray-900",children:ef}),(0,t.jsx)("div",{className:"mt-1 text-sm text-gray-600",children:eb})]}),(0,t.jsxs)(n.Card,{className:"rounded-2xl border bg-white p-4",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Bill status"}),(0,t.jsx)("div",{className:"mt-2",children:M?(0,t.jsx)("span",{className:"rounded-full border border-emerald-200 bg-emerald-50 px-2 py-1 text-xs font-semibold text-emerald-700",children:"Checked out"}):I?(0,t.jsx)("span",{className:"rounded-full border border-amber-200 bg-amber-50 px-2 py-1 text-xs font-semibold text-amber-700",children:"Not checked out"}):L.isLoading?(0,t.jsx)("span",{className:"rounded-full border px-2 py-1 text-xs font-semibold text-gray-700",children:"Loading…"}):null})]})]}),(0,t.jsxs)(n.Card,{className:"rounded-2xl border bg-white p-5",children:[(0,t.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between",children:[(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Total"}),(0,t.jsx)("div",{className:"mt-1 text-3xl font-extrabold text-gray-900",children:em.total.toFixed(2)}),(0,t.jsxs)("div",{className:"mt-1 text-xs text-gray-500",children:["Subtotal ",em.subtotal.toFixed(2)," · Discount ",em.discount.toFixed(2)," · Tax ",em.tax.toFixed(2)]}),(0,t.jsxs)("div",{className:"mt-4 flex flex-wrap items-center gap-4",children:[(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[(0,t.jsx)("input",{type:"checkbox",className:"h-4 w-4 cursor-pointer",checked:el,onChange:e=>{let t=e.target.checked;ed(t),t&&ec(!1)}}),"Received online"]}),(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[(0,t.jsx)("input",{type:"checkbox",className:"h-4 w-4 cursor-pointer",checked:eo,onChange:e=>{let t=e.target.checked;ec(t),t&&ed(!1)}}),"Received offline"]}),el&&eo?(0,t.jsx)("span",{className:"text-xs text-red-600",children:"Choose only one"}):null]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 w-full justify-end",children:[(0,t.jsxs)("div",{className:"rounded-xl border bg-white px-3 py-2",children:[(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:"Discount"}),(0,t.jsx)(l.Input,{className:"mt-1 h-9 rounded-xl",inputMode:"decimal",value:String(Q),onChange:e=>_(Number(e.target.value||0)),disabled:ex})]}),(0,t.jsxs)("div",{className:"rounded-xl border bg-white px-3 py-2",children:[(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tax"}),(0,t.jsx)(l.Input,{className:"mt-1 h-9 rounded-xl",inputMode:"decimal",value:String(z),onChange:e=>Y(Number(e.target.value||0)),disabled:ex})]})]})]}),(0,t.jsx)("div",{className:["mt-2 rounded-2xl border bg-gray-50 p-4",ex?"opacity-50 pointer-events-none select-none":""].join(" "),children:(0,t.jsxs)("div",{className:"flex gap-3 items-end",children:[(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)(d.Label,{className:"text-xs text-gray-600",children:"Service"}),(0,t.jsx)(l.Input,{ref:ev,className:"mt-1 h-11 rounded-xl bg-white",value:H,onChange:e=>J(e.target.value),placeholder:"e.g. Consultation / Filling / Extraction",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),ej.current?.focus())}})]}),(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)(d.Label,{className:"text-xs text-gray-600",children:"Amount"}),(0,t.jsx)(l.Input,{ref:ej,className:"mt-1 h-11 rounded-xl bg-white",inputMode:"decimal",value:X,onChange:e=>ee(e.target.value),placeholder:"0",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),eN.current?.focus())}})]}),(0,t.jsx)("div",{className:"flex",children:(0,t.jsx)(r.Button,{ref:eN,type:"button",variant:"default",className:"w-11 rounded-xl bg-black p-0 text-white hover:bg-black/90 cursor-pointer",onClick:()=>{if(ex)return;let e=H.trim(),t=Math.max(0,u(X));if(!e){a.toast.info("Enter a service name."),ev.current?.focus();return}G(s=>[...s,{description:e,unitAmount:t}]),J(""),ee(""),requestAnimationFrame(()=>ev.current?.focus())},title:"Add",children:(0,t.jsx)(f,{className:"h-5 w-5"})})})]})}),(0,t.jsx)("div",{className:"mt-2 space-y-2",children:0===W.length?(0,t.jsx)("div",{className:"rounded-2xl border border-dashed bg-gray-50 p-6 text-sm text-gray-600",children:"No services added yet. Add a service and amount above."}):W.map((e,s)=>{let i=et===s;return(0,t.jsx)("div",{className:"rounded-2xl border bg-white p-4",children:i?(0,t.jsxs)("div",{className:"grid grid-cols-13 items-end gap-3",children:[(0,t.jsxs)("div",{className:"col-span-12 md:col-span-7",children:[(0,t.jsx)(d.Label,{className:"text-xs text-gray-600",children:"Service"}),(0,t.jsx)(l.Input,{ref:ey,className:"mt-1 h-10 rounded-xl",value:ei,onChange:e=>ea(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),ek.current?.focus()),"Escape"===e.key&&eA()},disabled:ex})]}),(0,t.jsxs)("div",{className:"col-span-10 md:col-span-4",children:[(0,t.jsx)(d.Label,{className:"text-xs text-gray-600",children:"Amount"}),(0,t.jsx)(l.Input,{ref:ek,className:"mt-1 h-10 rounded-xl",inputMode:"decimal",value:er,onChange:e=>en(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),ew()),"Escape"===e.key&&eA()},disabled:ex})]}),(0,t.jsxs)("div",{className:"col-span-2 md:col-span-1 flex justify-start gap-2",children:[(0,t.jsx)(r.Button,{type:"button",variant:"default",className:"h-10 rounded-xl bg-black text-white hover:bg-black/90",onClick:ew,disabled:ex,children:"Save"}),(0,t.jsx)(r.Button,{type:"button",variant:"outline",className:"h-10 rounded-xl",onClick:eA,children:"Cancel"})]})]}):(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)("div",{className:"truncate text-sm font-semibold text-gray-900",children:e.description||"—"}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Amount"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"tabular-nums text-base font-bold text-gray-900",children:u(e.unitAmount).toFixed(2)}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-xl border bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 cursor-pointer",onClick:()=>(e=>{if(ex)return;let t=W[e];es(e),ea(t?.description??""),en(String(t?.unitAmount??0)),requestAnimationFrame(()=>ey.current?.focus())})(s),disabled:ex,title:"Edit",children:(0,t.jsx)(b,{className:"h-4 w-4"})}),(0,t.jsx)("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-xl border bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 cursor-pointer",onClick:()=>{!ex&&(G(e=>e.filter((e,t)=>t!==s)),requestAnimationFrame(()=>ev.current?.focus()))},disabled:ex,title:"Delete",children:(0,t.jsx)(v,{className:"h-4 w-4"})})]})]})]})},`${s}-${e.description}`)})}),(0,t.jsx)("div",{className:"mt-4 rounded-2xl border border-dashed bg-gray-50 p-4 text-sm text-gray-600",children:"Tip: Enter → Amount, Enter → Add, Enter → Next service."})]})]})}e.s(["default",()=>j])}]);