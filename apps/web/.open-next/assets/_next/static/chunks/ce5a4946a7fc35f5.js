(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,67585,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"BailoutToCSR",{enumerable:!0,get:function(){return s}});let r=e.r(32061);function s({reason:e,children:t}){if("undefined"==typeof window)throw Object.defineProperty(new r.BailoutToCSRError(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return t}},9885,(e,t,i)=>{"use strict";function r(e){return e.split("/").map(e=>encodeURIComponent(e)).join("/")}Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"encodeURIPath",{enumerable:!0,get:function(){return r}})},52157,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"PreloadChunks",{enumerable:!0,get:function(){return o}});let r=e.r(43476),s=e.r(74080),n=e.r(63599),a=e.r(9885),l=e.r(43369);function o({moduleIds:e}){if("undefined"!=typeof window)return null;let t=n.workAsyncStorage.getStore();if(void 0===t)return null;let i=[];if(t.reactLoadableManifest&&e){let r=t.reactLoadableManifest;for(let t of e){if(!r[t])continue;let e=r[t].files;i.push(...e)}}if(0===i.length)return null;let o=(0,l.getDeploymentIdQueryOrEmptyString)();return(0,r.jsx)(r.Fragment,{children:i.map(e=>{let i=`${t.assetPrefix}/_next/${(0,a.encodeURIPath)(e)}${o}`;return e.endsWith(".css")?(0,r.jsx)("link",{precedence:"dynamic",href:i,rel:"stylesheet",as:"style",nonce:t.nonce},e):((0,s.preload)(i,{as:"script",fetchPriority:"low",nonce:t.nonce}),null)})})}},69093,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"default",{enumerable:!0,get:function(){return d}});let r=e.r(43476),s=e.r(71645),n=e.r(67585),a=e.r(52157);function l(e){return{default:e&&"default"in e?e.default:e}}let o={loader:()=>Promise.resolve(l(()=>null)),loading:null,ssr:!0},d=function(e){let t={...o,...e},i=(0,s.lazy)(()=>t.loader().then(l)),d=t.loading;function u(e){let l=d?(0,r.jsx)(d,{isLoading:!0,pastDelay:!0,error:null}):null,o=!t.ssr||!!t.loading,u=o?s.Suspense:s.Fragment,c=t.ssr?(0,r.jsxs)(r.Fragment,{children:["undefined"==typeof window?(0,r.jsx)(a.PreloadChunks,{moduleIds:t.modules}):null,(0,r.jsx)(i,{...e})]}):(0,r.jsx)(n.BailoutToCSR,{reason:"next/dynamic",children:(0,r.jsx)(i,{...e})});return(0,r.jsx)(u,{...o?{fallback:l}:{},children:c})}return u.displayName="LoadableComponent",u}},70703,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"default",{enumerable:!0,get:function(){return s}});let r=e.r(55682)._(e.r(69093));function s(e,t){let i={};"function"==typeof e&&(i.loader=e);let s={...i,...t};return(0,r.default)({...s,modules:s.loadableGenerated?.modules})}("function"==typeof i.default||"object"==typeof i.default&&null!==i.default)&&void 0===i.default.__esModule&&(Object.defineProperty(i.default,"__esModule",{value:!0}),Object.assign(i.default,i),t.exports=i.default)},95705,e=>{"use strict";var t=e.i(43476),i=e.i(71645),r=e.i(70703),s=e.i(18566),n=e.i(70319),a=e.i(66691),l=e.i(70317),o=e.i(6662),d=e.i(70931),u=e.i(50106);let c=(0,r.default)(()=>e.A(35154).then(e=>e.PrescriptionPreview),{loadableGenerated:{modules:[89181]},ssr:!1,loading:()=>(0,t.jsxs)("div",{className:"rounded-2xl border bg-white p-4",children:[(0,t.jsx)("div",{className:"h-4 w-48 animate-pulse rounded bg-gray-100"}),(0,t.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,t.jsx)("div",{className:"h-3 w-full animate-pulse rounded bg-gray-100"}),(0,t.jsx)("div",{className:"h-3 w-5/6 animate-pulse rounded bg-gray-100"}),(0,t.jsx)("div",{className:"h-3 w-4/6 animate-pulse rounded bg-gray-100"}),(0,t.jsx)("div",{className:"h-3 w-3/6 animate-pulse rounded bg-gray-100"})]}),(0,t.jsx)("div",{className:"mt-4 h-32 animate-pulse rounded-xl bg-gray-50"})]})}),f=(0,r.default)(()=>e.A(2179).then(e=>e.XrayTrayReadOnly),{loadableGenerated:{modules:[77950]},ssr:!1,loading:()=>(0,t.jsx)("div",{className:"h-72 w-full animate-pulse rounded-2xl bg-gray-100"})});function m(e){return"object"==typeof e&&null!==e}function g(e){return"string"==typeof e&&e.trim()?e:void 0}function p(e,t){if(m(e))return e[t]}function h(e,t){return g(p(e,t))}function x(e,t){var i;return"number"==typeof(i=p(e,t))&&Number.isFinite(i)?i:void 0}function v(e){if(e instanceof Error&&e.message)return e.message;if(m(e)){let t=p(e,"data");if(m(t)){let e=g(p(t,"message"));if(e)return e}let i=g(p(e,"message"));if(i)return i}return"Request failed."}function b(){var e,r;let b,y,N,j,w,O=(0,s.useParams)(),I=(0,s.useRouter)(),M=(0,u.useAuth)(),A=String(O?.visitId??""),[P,k]=i.useState(!1),F=(0,d.useGetVisitByIdQuery)(A,{skip:!A,refetchOnMountOrArgChange:!0}),S=F.data??null,D=!!S?.isOffline,R=S?.patientId,C=(0,d.useGetPatientByIdQuery)(R??"",{skip:!R,refetchOnMountOrArgChange:!0}),L=(0,d.useGetDoctorsQuery)(void 0),E=(0,d.useGetPatientVisitsQuery)(R??"",{skip:!R||!P,refetchOnMountOrArgChange:!0}),$=i.useMemo(()=>{if(!P)return[];let e=p(E.data,"items");return Array.isArray(e)?e:[]},[E.data,P]),T=(0,d.useGetVisitRxVersionsQuery)({visitId:A},{skip:!A,refetchOnMountOrArgChange:!0}),V=i.useMemo(()=>{let e=p(T.data,"versions");return Array.isArray(e)?e.filter(e=>Number.isFinite(e)&&e>0):[]},[T.data]),_=i.useMemo(()=>V.length?Math.max(...V):null,[V]),[B,U]=i.useState(null);i.useEffect(()=>{null==B&&null!=_&&U(_)},[_,B]);let G=(0,d.useGetVisitRxQuery)({visitId:A},{skip:!A,refetchOnMountOrArgChange:!0}),Q=(0,d.useGetVisitRxQuery)({visitId:A,version:B??void 0},{skip:!A||null==B,refetchOnMountOrArgChange:!0}),Y=i.useMemo(()=>{let e=p(Q.data,"rx")??null,t=p(G.data,"rx")??null;return e??t},[Q.data,G.data]),K=i.useMemo(()=>{if(!Y||!m(Y))return[];let e=p(Y,"toothDetails");return Array.isArray(e)?e:[]},[Y]),X=i.useMemo(()=>Y&&m(Y)?String(p(Y,"doctorNotes")??""):"",[Y]),[q,H]=(0,d.useUpdateVisitRxReceptionNotesMutation)(),[W,z]=i.useState(""),J=i.useRef(!1),Z=i.useMemo(()=>null==_||null==B||B===_,[B,_]);i.useEffect(()=>{J.current=!1},[B]),i.useEffect(()=>{if(A&&!J.current&&!(G.isLoading||G.isFetching||Q.isLoading||Q.isFetching))if(J.current=!0,Y&&m(Y)){let e=p(Y,"receptionNotes");z("string"==typeof e?e:"")}else z("")},[A,Y,G.isLoading,G.isFetching,Q.isLoading,Q.isFetching]);let ee=async()=>{if(A){if(!Y)return void n.toast.error("No prescription found for this visit.");if(!Z)return void n.toast.info("Reception Notes can be edited only on the latest prescription version.");try{await q({visitId:A,receptionNotes:W}).unwrap(),n.toast.success("Notes saved."),G.refetch(),Q.refetch()}catch(e){n.toast.error(v(e)??"Failed to save notes.")}}},et=p(C.data,"name"),ei=p(C.data,"phone"),er=C.data,es=m(er)?er:void 0,en=h(C.data,"sdId")??g(S?.sdId),ea=g(S?.opdNo)??g(S?.opdId)??g(S?.opdNumber)??void 0,el=p(C.data,"dob")??p(es,"dateOfBirth")??p(es,"birthDate")??p(es,"dobIso")??null,eo=p(C.data,"gender")??p(es,"sex")??p(es,"patientSex")??null,ed=function(e){if(!e)return null;if("number"==typeof e&&Number.isFinite(e)){let t=new Date(e);return Number.isFinite(t.getTime())?t:null}if("string"==typeof e){let t=e.trim();if(!t)return null;let i=/^(\d{4})-(\d{2})-(\d{2})$/.exec(t);if(i){let e=new Date(Number(i[1]),Number(i[2])-1,Number(i[3]));return Number.isFinite(e.getTime())?e:null}let r=new Date(t);return Number.isFinite(r.getTime())?r:null}return e instanceof Date&&Number.isFinite(e.getTime())?e:null}(el),eu=x(S,"createdAt")??Date.now(),ec=ed?(b=(e=new Date(eu)).getFullYear()-ed.getFullYear(),((y=e.getMonth()-ed.getMonth())<0||0===y&&e.getDate()<ed.getDate())&&(b-=1),b<0?0:b):void 0,ef=function(e){if(!e)return;let t=String(e).trim().toUpperCase();return"M"===t||"MALE"===t?"M":"F"===t||"FEMALE"===t?"F":"O"===t||"OTHER"===t?"O":"U"===t||"UNKNOWN"===t?"U":"M"===t||"F"===t||"O"===t||"U"===t?t:void 0}(eo),em=g(S?.doctorId),eg=i.useMemo(()=>{let e=L.data;return em&&Array.isArray(e)?e.filter(m).map(e=>e).find(e=>e.doctorId===em)??null:null},[L.data,em]),ep=eg?.fullName??eg?.name??eg?.displayName??void 0,eh=eg?.registrationNumber??void 0,ex=i.useMemo(()=>ep&&!function(e){if(!e)return!0;let t=e.trim();return!!(!t||/^Doctor\s*\(.+\)$/i.test(t)||/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))}(ep)?ep:L.isLoading||L.isFetching?void 0:em?`Doctor (${em})`:void 0,[ep,L.isLoading,L.isFetching,em]),ev=i.useMemo(()=>{if(eh)return`B.D.S Regd. - ${eh}`},[eh]),eb=eu?`Visit: ${N=(r=new Date(eu)).getFullYear(),j=String(r.getMonth()+1).padStart(2,"0"),w=String(r.getDate()).padStart(2,"0"),`${N}-${j}-${w}`}`:void 0,ey="authenticated"===M.status?M.role:void 0,eN=!!(S&&"DONE"===h(S,"status")),ej=S?.checkedOut===!0,ew=ej?`/visits/${A}/checkout/printing`:`/visits/${A}/checkout/billing`,[eO,eI]=(0,d.useUpdateVisitStatusMutation)(),[eM,eA]=i.useState(!1),eP=async()=>{if(A&&S)try{eA(!0),"DONE"!==h(S,"status")&&(await eO({visitId:A,status:"DONE"}).unwrap(),await F.refetch()),I.push(`/visits/${A}/checkout/billing`)}catch(e){n.toast.error(v(e)??"Failed to mark visit DONE.")}finally{eA(!1)}},ek=!S||eM||eI.isLoading||!ej&&!eN&&!D,eF=i.useMemo(()=>{let e=new Map;if(S?.visitId&&e.set(S.visitId,S),!P)return{visitIds:[A],meta:e,currentVisitId:A};for(let t of $)e.set(t.visitId,t);S?.visitId&&e.set(S.visitId,S);let t=h(S,"tag"),i=h(S,"anchorVisitId"),r="F"===t?i:A;if(!r)return{visitIds:[A],meta:e,currentVisitId:A};let s=e.get(r),n=[];s&&n.push(s);let a=[];for(let t of e.values()){let e=h(t,"anchorVisitId")??h(t,"anchorId")??void 0;e&&e===r&&t.visitId!==r&&a.push(t)}if(a.sort((e,t)=>(x(e,"createdAt")??x(e,"updatedAt")??0)-(x(t,"createdAt")??x(t,"updatedAt")??0)),n.push(...a),!n.some(e=>e.visitId===A)){let t=e.get(A);n.push(t??{visitId:A})}n.sort((e,t)=>(x(e,"createdAt")??x(e,"updatedAt")??0)-(x(t,"createdAt")??x(t,"updatedAt")??0));let l=new Set,o=n.map(e=>e.visitId).filter(e=>!(!e||l.has(e))&&(l.add(e),!0)),d=o.indexOf(A);return{visitIds:d>=0?o.slice(0,d+1):[A],meta:e,currentVisitId:A}},[$,S,A,P]),eS=i.useMemo(()=>{if(!V.length)return[];let e=_??null;return e?Array.from({length:e},(t,i)=>e-i):[]},[V,_]),eD=G.isLoading||G.isFetching||Q.isLoading||Q.isFetching,eR=!!Y,eC=P&&(E.isLoading||E.isFetching);return(0,t.jsxs)("section",{className:"p-4 2xl:p-8",children:[(0,t.jsxs)("div",{className:"mb-4 flex items-center justify-between gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:"Visit Info"}),D?(0,t.jsx)("div",{className:"mt-1 text-xs text-amber-600",children:"Offline visit"}):null]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[ej&&"ADMIN"===ey?(0,t.jsx)(a.Button,{type:"button",variant:"outline",className:"rounded-xl cursor-pointer",onClick:()=>I.push(`/visits/${A}/checkout/billing`),children:"Edit bill"}):null,(0,t.jsx)(a.Button,{type:"button",variant:"default",className:"rounded-xl bg-black text-white hover:bg-black/90 cursor-pointer",disabled:ek,title:S?ej?"View documents":D?"Proceed to billing (offline visit)":eN?"Checkout":"Checkout is allowed only when visit is DONE":"Loading visit…",onClick:()=>{ej?I.push(ew):D?eP():I.push(ew)},children:eM?"Preparing…":ej?"Print/Followup":"Checkout"})]})]}),(0,t.jsxs)("div",{className:"grid w-full grid-cols-1 gap-4 lg:grid-cols-10",children:[(0,t.jsxs)("div",{className:"lg:col-span-6 rounded-2xl border bg-white p-4",children:[(0,t.jsxs)("div",{className:"mb-3 flex items-center justify-between gap-2",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:"Prescription"}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:eD?"Loading…":eR?"Ready":"No prescription"})]}),P?(0,t.jsx)("div",{className:"mb-3 px-3 text-[11px] text-gray-600",children:eC?"Loading visit history…":`Showing visit history (${eF.visitIds.length} visit${1===eF.visitIds.length?"":"s"}).`}):null,(0,t.jsx)("div",{className:"flex items-center gap-2",children:(0,t.jsx)("button",{type:"button",className:["rounded-full px-3 py-1 text-[11px] font-medium transition cursor-pointer",P?"bg-black text-white hover:bg-black/90":"bg-gray-100 text-gray-800 hover:bg-gray-200"].join(" "),onClick:()=>k(e=>!e),title:"Toggle previous visit history in prescription",children:P?"Hide history":"Show history"})})]}),eS.length>0?(0,t.jsxs)("div",{className:"mb-3 flex flex-wrap items-center justify-between gap-2 rounded-xl border bg-gray-50 px-3 py-2",children:[(0,t.jsxs)("div",{className:"text-xs font-medium text-gray-700",children:["Prescription version",null!=B?(0,t.jsx)("span",{className:"text-gray-500",children:` • v${B}`}):null,Z?null:(0,t.jsx)("span",{className:"ml-2 rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-800",children:"Read-only (older version)"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("select",{className:"h-9 rounded-xl border bg-white px-3 text-sm",value:B??"",onChange:e=>U(Number(e.target.value)),disabled:Q.isFetching,children:eS.map(e=>(0,t.jsx)("option",{value:e,children:e===eS[0]?`Latest (v${e})`:`Version ${e}`},e))}),Q.isFetching?(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"Loading…"}):null]})]}):null,(0,t.jsx)("div",{className:"min-w-0 overflow-hidden",children:(0,t.jsx)(c,{patientName:et,patientPhone:ei,patientAge:ec,patientSex:ef,sdId:en,opdNo:ea,doctorName:ex,doctorRegdLabel:ev,visitDateLabel:eb,lines:m(Y)&&Array.isArray(p(Y,"lines"))?p(Y,"lines"):[],receptionNotes:W,toothDetails:K,currentVisitId:P?eF.currentVisitId:void 0,chainVisitIds:P?eF.visitIds:void 0,visitMetaMap:P?eF.meta:void 0})})]}),(0,t.jsxs)(l.Card,{className:"lg:col-span-4 rounded-2xl border bg-white p-4",children:[(0,t.jsx)("div",{className:"flex items-center justify-between border-b pb-3",children:(0,t.jsx)("div",{className:"text-lg font-semibold text-gray-900",children:"X-ray Tray"})}),(0,t.jsx)("div",{className:"mt-3",children:(0,t.jsx)(f,{visitId:A})}),(0,t.jsxs)("div",{className:"mt-4 rounded-2xl border bg-white p-3",children:[(0,t.jsx)("div",{className:"text-sm font-semibold text-gray-900",children:"Doctor Notes"}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Internal note from doctor for reception. This will NOT print."}),(0,t.jsx)("div",{className:"mt-3 min-h-20 whitespace-pre-wrap rounded-xl bg-gray-50 p-3 text-sm text-gray-800",children:X.trim()?X:"—"})]}),(0,t.jsxs)("div",{className:"mt-4 rounded-2xl border bg-white p-3",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"text-sm font-semibold text-gray-900",children:"Reception Notes"}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"These notes will appear on prescription & print."})]}),(0,t.jsx)(a.Button,{type:"button",variant:"default",className:"rounded-xl bg-black text-white hover:bg-black/90 cursor-pointer",onClick:()=>void ee(),disabled:H.isLoading||!Y||!Z,title:Y?Z?"Save notes":"Editing disabled for older versions":"No prescription found",children:H.isLoading?"Saving…":"Save"})]}),(0,t.jsx)(o.Textarea,{className:"mt-3 min-h-30 rounded-xl",placeholder:Z?"Add reception notes (will print on the prescription)…":"Reception Notes are read-only for older versions. Switch to Latest to edit.",value:W,onChange:e=>z(e.target.value),disabled:!Y||!Z}),Y?Z?null:(0,t.jsxs)("div",{className:"mt-2 text-xs text-amber-600",children:["You’re viewing an older prescription version. Switch to ",(0,t.jsx)("b",{children:"Latest"})," to edit notes."]}):(0,t.jsx)("div",{className:"mt-2 text-xs text-amber-600",children:"No prescription found for this visit. Notes require a prescription."})]})]})]})]})}e.s(["default",()=>b])},35154,e=>{e.v(t=>Promise.all(["static/chunks/857324084bba1f93.js"].map(t=>e.l(t))).then(()=>t(89181)))},2179,e=>{e.v(t=>Promise.all(["static/chunks/569111530486137f.js"].map(t=>e.l(t))).then(()=>t(77950)))}]);