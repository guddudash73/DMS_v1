name: Deploy (prod)

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      SST_STAGE: prod
      SST_PASSPHRASE: ${{ secrets.SST_PASSPHRASE }}
      QZ_PRIVATE_KEY_SECRET_ID: ${{ secrets.QZ_PRIVATE_KEY_SECRET_ID }}
      NODE_OPTIONS: --max-old-space-size=8192
      SST_TELEMETRY_DISABLED: '1'
      TURBO_TELEMETRY_DISABLED: '1'
      HUSKY: '0'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - run: npm install -g npm@11.6.2

      - run: npm ci --ignore-scripts

      - run: |
          set -euxo pipefail
          which pulumi || true
          which pulumi-language-nodejs || true
          sudo rm -f /usr/local/bin/pulumi || true
          sudo rm -f /usr/local/bin/pulumi-language-nodejs || true
          sudo rm -f /usr/local/bin/pulumi-language-python || true
          sudo rm -f /usr/local/bin/pulumi-language-go || true
          sudo rm -f /usr/local/bin/pulumi-language-dotnet || true
          which pulumi || true
          which pulumi-language-nodejs || true

      - run: |
          set -euxo pipefail
          npm run build --workspace=@dcm/config
          npm run build --workspace=@dcm/types
          test -f packages/types/dist/index.js
          test -f packages/config/dist/env.js
          test -n "${SST_PASSPHRASE}"
          test -n "${QZ_PRIVATE_KEY_SECRET_ID}"

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::512491905643:role/github-actions-sarangi-dcm-deploy
          aws-region: ${{ env.AWS_REGION }}

      - run: |
          set -euxo pipefail
          npx sst version >/dev/null
          node <<'NODE'
          const fs = require("fs");
          const path = require("path");

          const candidates = [
            ".sst/platform/node_modules/@pulumi/cmd/run/error.ts",
            ".sst/platform/node_modules/@pulumi/cmd/run/error.js",
          ];

          const patch = (file) => {
            if (!fs.existsSync(file)) return false;
            let s = fs.readFileSync(file, "utf8");
            if (s.includes("SAFE_PULUMI_ERROR_MESSAGE")) return true;

            const re = /function\s+defaultErrorMessage\s*\([\s\S]*?\)\s*\{[\s\S]*?\n\}/m;
            if (!re.test(s)) {
              console.log("[patch] defaultErrorMessage not found in", file);
              return false;
            }

            const replacement = `function defaultErrorMessage(err) {
            // SAFE_PULUMI_ERROR_MESSAGE
              try {
                if (err && typeof err === "object") {
                  const msg = err.message || err.toString();
                  if (typeof msg === "string" && msg.length) return msg;
                }
                return String(err);
              } catch (e) {
                return "Pulumi error (failed to render safely)";
              }
            }`;

            s = s.replace(re, replacement);
            fs.writeFileSync(file, s, "utf8");
            console.log("[patch] patched", file);
            return true;
          };

          let ok = false;
          for (const f of candidates) ok = patch(f) || ok;

          if (!ok) {
            console.log("[patch] no files patched; listing pulumi run dir:");
            const dir = ".sst/platform/node_modules/@pulumi/cmd/run";
            if (fs.existsSync(dir)) console.log(fs.readdirSync(dir));
            process.exit(0);
          }
          NODE

      - run: |
          set -euxo pipefail
          npx sst deploy --stage "$SST_STAGE"
