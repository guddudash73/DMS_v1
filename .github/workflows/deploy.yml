name: Deploy (prod)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      SST_STAGE: prod
      SST_PASSPHRASE: ${{ secrets.SST_PASSPHRASE }}
      QZ_PRIVATE_KEY_SECRET_ID: ${{ secrets.QZ_PRIVATE_KEY_SECRET_ID }}
      NODE_OPTIONS: '--max-old-space-size=4096'
      SST_TELEMETRY_DISABLED: '1'
      TURBO_TELEMETRY_DISABLED: '1'
      HUSKY: '0'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Pin npm
        run: npm install -g npm@11.6.2

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Remove preinstalled Pulumi binaries
        run: |
          set -euxo pipefail
          which pulumi || true
          which pulumi-language-nodejs || true
          sudo rm -f /usr/local/bin/pulumi || true
          sudo rm -f /usr/local/bin/pulumi-language-nodejs || true
          sudo rm -f /usr/local/bin/pulumi-language-python || true
          sudo rm -f /usr/local/bin/pulumi-language-go || true
          sudo rm -f /usr/local/bin/pulumi-language-dotnet || true
          which pulumi || true
          which pulumi-language-nodejs || true

      - name: Build workspace packages
        run: |
          set -euxo pipefail
          npm run build --workspace=@dcm/config
          npm run build --workspace=@dcm/types
          test -f packages/types/dist/index.js
          test -f packages/config/dist/env.js
          test -n "$SST_PASSPHRASE"
          test -n "$QZ_PRIVATE_KEY_SECRET_ID"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::512491905643:role/github-actions-sarangi-dcm-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Patch Pulumi error renderer (unchanged logic)
        run: |
          set -euxo pipefail
          npx sst --help >/dev/null 2>&1 || true
          node <<'NODE'
          const fs = require("fs");
          const path = ".sst/platform/node_modules/@pulumi/cmd/run/error.js";
          if (!fs.existsSync(path)) process.exit(0);
          let s = fs.readFileSync(path, "utf8");
          if (s.includes("SAFE_PULUMI_ERROR_MESSAGE")) process.exit(0);
          s = s.replace(
            /function defaultErrorMessage\([\s\S]*?\)\s*\{[\s\S]*?\n\}/m,
            `function defaultErrorMessage(err) {
              // SAFE_PULUMI_ERROR_MESSAGE
              try {
                if (err && typeof err === "object") {
                  const msg = err.message || err.toString();
                  if (typeof msg === "string" && msg.length) return msg;
                }
                return String(err);
              } catch (e) {
                return "Pulumi error (failed to render safely)";
              }
            }`
          );
          fs.writeFileSync(path, s, "utf8");
          NODE

      - name: Deploy with SST
        run: npx sst deploy --stage "$SST_STAGE"
