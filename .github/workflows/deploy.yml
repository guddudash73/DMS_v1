name: Deploy (prod)

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      SST_STAGE: prod
      SST_PASSPHRASE: ${{ secrets.SST_PASSPHRASE }}
      QZ_PRIVATE_KEY_SECRET_ID: ${{ secrets.QZ_PRIVATE_KEY_SECRET_ID }}

      # Optional during bootstrap; set after first successful prod deploy
      NEXT_PUBLIC_WS_BASE_URL: ${{ secrets.NEXT_PUBLIC_WS_BASE_URL }}

      NODE_OPTIONS: --max-old-space-size=8192
      SST_TELEMETRY_DISABLED: '1'
      TURBO_TELEMETRY_DISABLED: '1'
      HUSKY: '0'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - run: npm install -g npm@11.6.2

      - run: npm ci --ignore-scripts

      - run: |
          set -euxo pipefail
          which pulumi || true
          which pulumi-language-nodejs || true
          sudo rm -f /usr/local/bin/pulumi || true
          sudo rm -f /usr/local/bin/pulumi-language-nodejs || true
          sudo rm -f /usr/local/bin/pulumi-language-python || true
          sudo rm -f /usr/local/bin/pulumi-language-go || true
          sudo rm -f /usr/local/bin/pulumi-language-dotnet || true
          which pulumi || true
          which pulumi-language-nodejs || true

      - run: |
          set -euxo pipefail
          npm run build --workspace=@dcm/config
          npm run build --workspace=@dcm/types
          test -f packages/types/dist/index.js
          test -f packages/config/dist/env.js
          test -n "${SST_PASSPHRASE}"
          test -n "${QZ_PRIVATE_KEY_SECRET_ID}"

          # âœ… Bootstrap-friendly: WS URL may not exist before first deploy
          if [ -z "${NEXT_PUBLIC_WS_BASE_URL}" ]; then
            echo "::warning::NEXT_PUBLIC_WS_BASE_URL is not set. Realtime UI will not connect until after first prod deploy. Set it and redeploy."
          fi

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::512491905643:role/github-actions-sarangi-dcm-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Patch Pulumi error rendering (prevents RangeError masking)
        run: |
          set -euxo pipefail
          npx sst version >/dev/null

          node <<'NODE'
          const fs = require("fs");

          const targets = [
            ".sst/platform/node_modules/@pulumi/cmd/run/error.js",
            ".sst/platform/node_modules/@pulumi/cmd/run/error.ts",
            ".sst/platform/node_modules/@pulumi/pulumi/cmd/run/error.js",
            ".sst/platform/node_modules/@pulumi/pulumi/cmd/run/error.ts",
          ];

          const needle = "return util.inspect(err, { colors: true });";

          const replacement = `
          try {
            return util.inspect(err, { colors: true });
          } catch (inspectError) {
            const max = 20000;
            const trunc = (s) =>
              typeof s === "string" && s.length > max
                ? s.slice(0, max) + "\\n... [truncated " + (s.length - max) + " chars]"
                : s;

            const msg = typeof err?.message === "string" ? err.message : undefined;
            const stack = typeof err?.stack === "string" ? err.stack : undefined;
            return trunc(msg) || trunc(stack) || ("Pulumi error (inspection failed): " + String(inspectError?.message || inspectError));
          }`.trim();

          let patched = 0;

          for (const file of targets) {
            if (!fs.existsSync(file)) continue;
            const s = fs.readFileSync(file, "utf8");
            if (s.includes("inspection failed")) continue;

            if (s.includes(needle)) {
              fs.writeFileSync(file, s.replace(needle, replacement), "utf8");
              console.log("[pulumi-error-patch] patched:", file);
              patched++;
            }
          }

          console.log("[pulumi-error-patch] total patched:", patched);
          if (patched === 0) {
            console.log("[pulumi-error-patch] WARNING: nothing patched.");
          }
          NODE

      - name: Deploy
        run: |
          set -euxo pipefail
          npx sst deploy --stage "$SST_STAGE"

      - name: Dump SST logs on failure
        if: failure()
        run: |
          set -euxo pipefail
          echo "===== .sst/log/sst.log (tail) ====="
          test -f .sst/log/sst.log && tail -n 400 .sst/log/sst.log || true
          echo "===== .sst/log (ls) ====="
          ls -la .sst/log || true
